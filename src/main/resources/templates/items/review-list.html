<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}" lang="ko">
<head>
  <title>내 상품후기</title>

  <th:block layout:fragment="page_head">
    <link rel="stylesheet" th:href="@{/css/pages/mypage.css}">
    <link rel="stylesheet" th:href="@{/css/shop/review-modal.css(v=${T(java.time.Instant).now().toEpochMilli()})}">

    <style>
      /* ===================== 카드 레이아웃 ===================== */
      .review-card{border:1px solid #e9ecef;border-radius:14px;background:#fff;overflow:hidden;margin-bottom:16px}
      .rc-head{display:grid;grid-template-columns:96px 1fr;gap:14px;padding:14px 16px;border-bottom:1px solid #f1f5f9;background:#fbfbfc}
      .rc-thumb{width:96px;height:96px;border-radius:10px;object-fit:cover;background:#f6f6f6}
      .rc-title{font-weight:700;line-height:1.25}
      .rc-meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px;color:#6b7280;font-size:.9rem}
      .rc-body{padding:14px 16px}
      .rc-media{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
      .rc-media img{width:100px;height:100px;object-fit:cover;border-radius:8px;background:#f6f6f6}
      .rc-text{color:#111827;white-space:pre-wrap;background:#f9fafb;border:1px solid #eef2f7;border-radius:10px;padding:12px}
      .rc-actions{display:flex;gap:8px;padding:10px 16px;border-top:1px solid #f1f5f9}

      /* ===================== 관리자 답글 ===================== */
      .rc-reply{margin:0 16px 14px 16px;display:grid;grid-template-columns:auto 1fr;gap:.45rem .6rem;align-items:flex-start;
        background:#f8fbff;border:1px solid #dbeafe;border-left:4px solid #3b82f6;border-radius:.6rem;padding:.6rem .8rem}
      .reply-label{align-self:center;font-weight:800;font-size:.78rem;color:#1e3a8a;
        background:#e0ecff;border:1px solid #c7ddff;padding:.12rem .6rem;border-radius:999px;white-space:nowrap}
      .reply-body{grid-column:2}
      .reply-text{color:#0f172a;white-space:pre-wrap;line-height:1.55}
      .reply-meta{font-size:.78rem;color:#64748b;margin-top:.25rem}
    </style>

    <!-- ✅ 서버 메타값 (CSRF + 로그인 정보) -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="memberName" th:content="${#authentication?.principal?.memberName}">
    <meta name="memberId"   th:content="${#authentication?.principal?.memberId}">
    <meta name="my-mno"     th:content="${myMno}">
    <meta name="page-size"  th:content="${pageSize}">
  </th:block>
</head>

<body>
<main layout:fragment="content" class="container-xxl py-4 shop-theme">

  <!-- Hero -->
  <section class="hero-wrap">
    <div class="hero-card card shadow-sm p-4 d-flex flex-row gap-4 align-items-center">
      <div>
        <div class="eyebrow">MY PAGE</div>
        <h1 class="hero-title">내가 남긴 <span class="accent" style="color:#16a34a">상품후기</span></h1>
        <p class="hero-sub text-muted mb-0">리뷰를 수정하거나 삭제할 수 있어요.</p>
      </div>
    </div>
  </section>

  <div class="row g-4 mt-3">
    <aside class="col-12 col-lg-3">
      <div th:replace="fragments/mypage-side :: side(${active})"></div>
    </aside>

    <section class="col-12 col-lg-9">
      <div id="loading" aria-hidden="true" class="mb-2">
        <div class="sk-card skeleton"></div>
        <div class="sk-card skeleton"></div>
        <div class="sk-card skeleton"></div>
      </div>

      <div id="reviews-container" class="mt-2" aria-live="polite"></div>

      <nav class="mt-3 text-center" aria-label="pagination">
        <div id="pager" class="pagination brand-paging justify-content-center"></div>
      </nav>
    </section>
  </div>

  <!-- ✅ 리뷰 등록/수정 공통 모달 -->
  <div id="review-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="rv-title">
      <div class="modal-hd">
        <h5 id="rv-title" class="mb-0">리뷰 작성/수정</h5>
        <button type="button" class="btn-close" aria-label="닫기" data-close></button>
      </div>

      <div class="modal-bd">
        <form id="review-form" enctype="multipart/form-data">
          <input type="hidden" name="itemId" id="rv-item-id">
          <input type="hidden" name="writerMno" id="rv-writer-mno" th:value="${myMno}">
          <input type="hidden" name="rating" id="rv-rating" value="5">

          <!-- ✅ 상품 이미지 + 상품명 -->
          <div class="rv-hero mb-3 text-center">
            <img id="rv-item-img" src="/img/No_Image.jpg" alt="상품 이미지"
                 class="rv-thumb" style="max-width:120px; border-radius:8px; margin-bottom:8px;">
            <div id="rv-item-name" class="form-control-plaintext fw-semibold">상품명</div>
          </div>

          <!-- ✅ 작성자 -->
          <div class="mb-3">
            <label class="form-label">작성자</label>
            <div id="rv-writer-name" class="form-control-plaintext">회원명</div>
          </div>

          <!-- ✅ 평점 위젯 -->
          <div class="mb-3">
            <label class="form-label d-block">평점</label>
            <div id="rv-stars" class="rv-stars" title="클릭/드래그로 별점을 선택하세요">
              <div class="bg">★★★★★</div>
              <div class="fill">★★★★★</div>
            </div>
            <small id="rv-rating-label" class="text-muted">5점</small>
          </div>

          <!-- ✅ 내용 -->
          <div class="mb-3">
            <label for="rv-content" class="form-label">내용</label>
            <textarea id="rv-content" name="content" class="form-control"
                      rows="5" maxlength="2000"
                      placeholder="리뷰 내용을 입력하세요 (최대 2000자)"></textarea>
          </div>

          <!-- ✅ 이미지 업로드 -->
          <div class="mb-2">
            <label class="form-label">이미지 (최대 3장, 3MB/장, jpg/jpeg/png/gif)</label>
            <input id="rv-images" name="images" type="file" class="form-control"
                   accept=".jpg,.jpeg,.png,.gif" multiple>
            <div id="rv-previews" class="rv-previews mt-2"></div>
          </div>

          <!-- ✅ 기존 이미지 교체 여부 -->
          <div class="form-check mb-2">
            <input id="replaceImages" class="form-check-input" type="checkbox" name="replaceImages">
            <label class="form-check-label" for="replaceImages">기존 이미지를 새 파일로 교체</label>
          </div>

          <div id="rv-error" class="text-danger small mt-1" role="alert"></div>
        </form>
      </div>

      <div class="modal-ft">
        <button type="button" class="btn btn-outline-secondary" data-close>취소</button>
        <button type="submit" id="rv-submit" class="btn btn-primary" form="review-form">등록</button>
      </div>
    </div>
  </div>


</main>

<th:block layout:fragment="page_foot">
  <script type="module" th:src="@{/js/shop/review-list.js(v=${T(java.time.Instant).now().toEpochMilli()})}"></script>
  <script th:src="@{/js/shop/review-modal.js(v=${T(java.time.Instant).now().toEpochMilli()})}" defer></script>
</th:block>
</body>
</html>
