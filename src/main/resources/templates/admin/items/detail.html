<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
  <title>관리자 · 상품 상세</title>

  <th:block layout:fragment="page_head">
    <link rel="stylesheet" th:href="@{/css/shop/shop-items.css}">
    <style>
      /* 모달/플로팅 버튼 */
      .admin-fab{position:fixed;right:24px;bottom:24px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
      .admin-fab .btn{box-shadow:0 4px 16px rgba(0,0,0,.12)}
      .review-admin-btns{gap:6px}
      .review-admin-btns .btn{padding:2px 8px;font-size:.85rem}

      /* 커스텀 모달 */
      .c-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1055}
      .c-modal.show{display:flex}
      .c-dialog{width:min(560px,92vw);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.25);display:flex;flex-direction:column}
      .c-header,.c-footer{padding:12px 16px}
      .c-header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee}
      .c-title{margin:0;font-size:1.1rem;font-weight:700}
      .c-close{appearance:none;border:0;background:transparent;font-size:20px;line-height:1;cursor:pointer}
      .c-body{padding:16px}
      .c-body textarea{width:100%;resize:vertical;min-height:120px}
      .c-footer{display:flex;gap:8px;justify-content:flex-end;border-top:1px solid #eee}
      .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
      .modal-open{overflow:hidden}

      /* 관리자 답변 DOM(라벨/본문 분리) */
      .review-reply{margin-top:.5rem;padding:.5rem .75rem;background:#fafafa;border:1px solid #eee;border-radius:.5rem;display:inline-flex;gap:.5rem;align-items:center}
      .reply-label{font-weight:700;color:#555;white-space:nowrap}
      .reply-text{color:#333;white-space:pre-wrap}
    </style>
  </th:block>

  <!-- CSRF -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <!-- 관리자 API 베이스 -->
  <meta name="admin-items-api-base"  content="/api/admin/items">
  <meta name="admin-reviews-api-base" content="/admin/reviews">

  <!-- 로그인 관리자 식별자(참고용) -->
  <meta name="admin-id"
        th:if="${#authorization.expression('isAuthenticated()')}"
        th:content="${#authentication.principal.memberId}">
</head>

<body>
<div layout:fragment="content"
     class="py-4 item-detail-page shop-theme"
     th:attr="data-item-id=${itemId},
              data-api-detail=@{'/api/items/' + ${itemId}},
              data-reviews=@{'/api/items/' + ${itemId} + '/reviews'}"
     th:data-sell-status="${item.itemSellStatus}"
     data-sticky-offset="72">

  <!-- 상단 요약 & 갤러리 -->
  <section class="container-xxl">
    <div class="row g-4 align-items-start">
      <div class="col-12 col-lg-6">
        <div class="gallery card shadow-sm">
          <img id="hero" class="hero-img" alt="">
          <div id="thumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="summary card shadow-sm">
          <div class="summary-head">
            <span id="badge" class="badge"></span>
            <span id="category" class="muted small"></span>
          </div>
          <h2 id="name" class="title"></h2>

          <div class="summary-meta">
            <span id="chip-category" class="chip d-none"></span>
            <span id="chip-food" class="chip d-none"></span>
          </div>

          <div class="summary-stats">
            <span class="stat"><i class="bi bi-star-fill"></i><span id="avg-rating">0.0</span></span>
            <a class="stat link-reviews" href="#section-reviews"><i class="bi bi-chat-dots"></i><span id="review-count-meta">0</span></a>
            <span class="stat"><i class="bi bi-eye"></i><span id="view-cnt">0</span></span>
          </div>

          <div class="price-row">
            <div class="d-flex align-items-end gap-2 flex-wrap">
              <div class="d-flex align-items-end gap-2">
                <div id="sale-price" class="price"></div>
                <span id="discount-badge" class="badge text-bg-danger d-none"></span>
              </div>
              <div class="sub muted">
                <span id="original-price-wrap" class="d-none"><s id="original-price"></s></span>
                <span class="ms-2">남은 수량: <span id="stock"></span></span>
              </div>
            </div>
            <div id="saving-wrap" class="muted small d-none">
              <span>즉시할인 <b id="saving-amount"></b>원</span>
            </div>
          </div>

          <!-- 관리자 액션 -->
          <div class="d-flex gap-2 mt-3">
            <a href="/admin/items" class="btn btn-secondary">
              <i class="bi bi-list me-1"></i> 목록</a>

            <a th:href="@{'/admin/items/' + ${itemId} + '/edit'}" class="btn btn-primary">
              <i class="bi bi-pencil-square me-1"></i> 수정
            </a>
            <button id="btn-admin-delete" class="btn btn-danger">
              <i class="bi bi-trash3 me-1"></i> 삭제
            </button>
          </div>

          <!-- 사용자 구매 버튼 숨김 -->
          <div class="btns mt-3 d-none">
            <button id="btn-cart" class="btn btn-success btn-lg" disabled>장바구니</button>
            <button id="btn-buy" class="btn btn-outline-success btn-lg" disabled>바로구매</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 탭 -->
  <section class="container-xxl detail-tabs-wrap">
    <div id="detail-tabs" class="detail-tabs">
      <button class="tab active" data-target="#section-desc">상품설명</button>
      <button class="tab" data-target="#section-reviews">구매후기(<span id="review-count">0</span>)</button>
    </div>
  </section>

  <!-- 상품설명 -->
  <section id="section-desc" class="container-xxl section-block">
    <div id="desc" class="desc d-none"></div>
    <div id="long-images" class="long-images"></div>
  </section>

  <!-- 구매후기 -->
  <section id="section-reviews" class="container-xxl section-block d-none">
    <div id="reviews-box" class="reviews-box" aria-live="polite">
      <div class="muted">구매후기를 불러오는 중…</div>
    </div>
    <nav class="mt-3">
      <ul id="reviews-pagination" class="pagination brand-paging justify-content-center mb-0"></ul>
    </nav>
  </section>

  <!-- 커스텀 리뷰 답변 모달 -->
  <div id="replyModal" class="c-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="replyModalTitle">
    <span class="visually-hidden" aria-hidden="true" tabindex="0" id="replyModalStart"></span>
    <div class="c-dialog" role="document">
      <div class="c-header">
        <h5 class="c-title" id="replyModalTitle">리뷰 답변</h5>
        <button type="button" class="c-close" data-close aria-label="닫기">×</button>
      </div>
      <div class="c-body">
        <textarea id="replyContent" rows="6" placeholder="답변 내용을 입력하세요"></textarea>
      </div>
      <div class="c-footer">
        <button type="button" class="btn btn-secondary" data-close>취소</button>
        <button type="button" class="btn btn-success" id="btn-save-reply">저장</button>
      </div>
    </div>
    <span class="visually-hidden" aria-hidden="true" tabindex="0" id="replyModalEnd"></span>
  </div>
</div>

<th:block layout:fragment="page_foot">
  <script th:src="@{/js/shop/items-detail.js(v=${T(java.time.Instant).now().toEpochMilli()})}"></script>
  <script th:src="@{/js/admin/item-detail.js(v=${T(java.time.Instant).now().toEpochMilli()})}"></script>
</th:block>
</body>
</html>
