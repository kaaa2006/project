<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
  <title>íšŒì› ì¡°íšŒ</title>

  <th:block layout:fragment="page_head">
    <style>
      .admin-members .toolbar .form-label { font-weight: 600; }
      .admin-members .search-row { row-gap: .5rem; }
      .admin-members .stat-chip { font-size: .78rem; padding: .25rem .5rem; border-radius: .5rem; }
      .admin-members .chip-role   { background: #e6f7ff; }
      .admin-members .chip-grade  { background: #e9fff7; }
      .admin-members .chip-status { background: #f3f4f6; }
      .admin-members .table thead th { white-space: nowrap; }
      .admin-members .table tbody td { vertical-align: middle; padding-top: .7rem; padding-bottom: .7rem; }
      .admin-members .empty { padding: 3rem 0; color: #777; text-align:center; }
      .admin-members .btn-primary { background:#00dca0; border-color:#00dca0; }
      .admin-members .btn-outline-secondary:hover { background:#f5f6f7; }
      .admin-members .sort-link { text-decoration: none; }
      .modal { z-index: 2000 !important; }
      .modal-backdrop { z-index: 1990 !important; }
    </style>
  </th:block>
</head>

<body>
<div layout:fragment="content" class="container-xxl py-4 admin-members">

  <h2 class="mb-3">íšŒì› ì¡°íšŒ</h2>

  <!-- ğŸ” ê²€ìƒ‰/í•„í„°/ì •ë ¬ -->
  <section class="toolbar card shadow-sm mb-3">
    <div class="card-body">
      <form method="get">
        <div class="row search-row align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label">ê²€ìƒ‰ì–´</label>
            <input type="text" class="form-control" name="keyword" placeholder="ì´ë¦„/ì´ë©”ì¼"
                   th:value="${keyword}">
          </div>

          <div class="col-6 col-md-4">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select name="category" class="form-select">
              <option value="" th:selected="${category==null or category==''}">ì „ì²´</option>
              <optgroup label="ì—­í• ">
                <option th:each="r : ${roles}" th:value="${r.name()}" th:text="${r.name()}"
                        th:selected="${category==r.name()}">USER</option>
              </optgroup>
              <optgroup label="ìƒíƒœ">
                <option value="ACTIVE" th:selected="${category=='ACTIVE'}">ACTIVE</option>
                <option value="WITHDRAWN" th:selected="${category=='WITHDRAWN'}">WITHDRAWN</option>
              </optgroup>
              <optgroup label="ë“±ê¸‰">
                <option th:each="g : ${grades}" th:value="${g.name()}" th:text="${g.name()}"
                        th:selected="${category==g.name()}">BASIC</option>
              </optgroup>
              <optgroup label="ì†Œì…œ">
                <option value="LOCAL" th:selected="${category=='LOCAL'}">LOCAL</option>
                <option value="KAKAO" th:selected="${category=='KAKAO'}">KAKAO</option>
                <option value="NAVER" th:selected="${category=='NAVER'}">NAVER</option>
              </optgroup>
            </select>
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label">ì •ë ¬</label>
            <select name="sort" class="form-select">
              <option value="desc"  th:selected="${sort=='desc'}">ìµœì‹ ìˆœ</option>
              <option value="asc"   th:selected="${sort=='asc'}">ì˜¤ë˜ëœìˆœ</option>
              <option value="grade" th:selected="${sort=='grade'}">ë“±ê¸‰ìˆœ</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">ê²€ìƒ‰</button>
            <a th:href="@{/admin/members}" class="btn btn-outline-secondary">ì´ˆê¸°í™”</a>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- ğŸ“‹ ê²°ê³¼ í…Œì´ë¸” -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
          <tr>
            <th style="width:80px">#</th>
            <th>ì´ë©”ì¼</th>
            <th>ì´ë¦„</th>
            <th>ì „í™”</th>
            <th>ë“±ê¸‰</th>
            <th>ì—­í• </th>
            <th>ìƒíƒœ</th>
            <th>í¬ì¸íŠ¸</th>
            <th>
              <span>ê°€ì…ì¼</span>
              <a class="sort-link ms-1"
                 th:if="${sort != 'grade'}"
                 th:href="@{|?page=0&size=${members.size}&keyword=${keyword}&category=${category}&sort=${sort=='desc'?'asc':'desc'}|}"
                 th:title="${sort=='desc'?'ì˜¤ë˜ëœìˆœ':'ìµœì‹ ìˆœ'}">
                <i class="bi" th:classappend="${sort=='desc' ? 'bi-arrow-down-short' : 'bi-arrow-up-short'}"></i>
              </a>
            </th>
            <th class="text-end" style="width:160px">ê´€ë¦¬</th>
          </tr>
          </thead>

          <!-- âœ… tbody í•˜ë‚˜ë§Œ -->
          <tbody>
          <!-- ë¹„ì–´ìˆìŒ -->
          <tr th:if="${members.totalElements == 0}">
            <td colspan="10" class="empty">ì¡°ê±´ì— ë§ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>

          <!-- ëª©ë¡ -->
          <tr th:each="m, stat : ${members}"
              th:with="rowNo=${members.number * members.size + stat.index + 1}"
              th:attr="data-mno=${m.mno},
                       data-name=${m.memberName},
                       data-role=${m.role},
                       data-grade=${m.grade},
                       data-points=${m.points}">
            <td th:text="${rowNo}">1</td>
            <td th:text="${m.email}">user@example.com</td>
            <td th:text="${m.memberName}">í™ê¸¸ë™</td>
            <td th:text="${m.phone}">010-0000-0000</td>
            <td><span class="stat-chip chip-grade"  th:text="${m.grade}">BASIC</span></td>
            <td><span class="stat-chip chip-role"   th:text="${m.role}">USER</span></td>
            <td><span class="stat-chip chip-status" th:text="${m.status}">ACTIVE</span></td>
            <td><span th:text="${#numbers.formatInteger(m.points, 1, 'COMMA')}">0</span></td>
            <td th:text="${#temporals.format(m.createdAt, 'yyyy-MM-dd')}">2025-08-27</td>
            <td class="text-end">
              <div class="btn-group">
                <button type="button" class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#editModal"
                        th:attr="data-mno=${m.mno},
                                 data-name=${m.memberName},
                                 data-role=${m.role},
                                 data-grade=${m.grade},
                                 data-points=${m.points}">
                  ìˆ˜ì •
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm"
                        data-bs-toggle="modal" data-bs-target="#deleteModal"
                        th:attr="data-mno=${m.mno},
                                 data-name=${m.memberName},
                                 data-status=${m.status}">
                  ì‚­ì œ
                </button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- í˜ì´ì§• -->
    <div class="card-footer bg-white">
      <nav th:if="${members.totalPages > 1}">
        <ul class="pagination mb-2">
          <li class="page-item" th:classappend="${members.first}? 'disabled'">
            <a class="page-link"
               th:href="@{|?page=${members.number-1}&size=${members.size}&keyword=${keyword}&category=${category}&sort=${sort}|}">ì´ì „</a>
          </li>
          <li class="page-item"
              th:each="i : ${#numbers.sequence(0, (members.totalPages > 4 ? 3 : members.totalPages-1))}"
              th:classappend="${members.number==i}? 'active'">
            <a class="page-link"
               th:text="${i+1}"
               th:href="@{|?page=${i}&size=${members.size}&keyword=${keyword}&category=${category}&sort=${sort}|}"></a>
          </li>
          <li class="page-item disabled" th:if="${members.totalPages > 5}">
            <span class="page-link">â€¦</span>
          </li>
          <li class="page-item" th:if="${members.totalPages > 5}"
              th:classappend="${members.number==(members.totalPages-1)}? 'active'">
            <a class="page-link"
               th:text="${members.totalPages}"
               th:href="@{|?page=${members.totalPages-1}&size=${members.size}&keyword=${keyword}&category=${category}&sort=${sort}|}"></a>
          </li>
          <li class="page-item" th:classappend="${members.last}? 'disabled'">
            <a class="page-link"
               th:href="@{|?page=${members.number+1}&size=${members.size}&keyword=${keyword}&category=${category}&sort=${sort}|}">ë‹¤ìŒ</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

</div>

<th:block layout:fragment="page_foot">
  <link rel="stylesheet" th:href="@{/webjars/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css}">

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" id="editForm" action="" data-base="/admin/members">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">íšŒì› ì •ë³´ ìˆ˜ì •</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="editName">ì´ë¦„</label>
              <input id="editName" type="text" name="memberName" class="form-control" required>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label" for="editGrade">ë“±ê¸‰</label>
                <select id="editGrade" name="grade" class="form-select">
                  <option th:each="g : ${grades}" th:value="${g.name()}" th:text="${g.name()}">BASIC</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="editRole">ì—­í• </label>
                <select id="editRole" name="role" class="form-select">
                  <option th:each="r : ${roles}" th:value="${r.name()}" th:text="${r.name()}">USER</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="editPoints">í¬ì¸íŠ¸</label>
              <input id="editPoints" type="number" name="points" class="form-control" min="0" step="1" placeholder="0">
            </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="keyword"  th:value="${keyword}">
            <input type="hidden" name="category" th:value="${category}">
            <input type="hidden" name="sort"     th:value="${sort}">
            <input type="hidden" name="page"     th:value="${members.number}">
            <input type="hidden" name="size"     th:value="${members.size}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ì‚­ì œ ëª¨ë‹¬ -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" id="deleteForm" action="" data-base="/admin/members">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">íšŒì› ì‚­ì œ / ìƒíƒœë³€ê²½</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="_memberName" value="">
            <div class="mb-2">ì²˜ë¦¬ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="mode" id="modeStatus" value="status" checked>
              <label class="form-check-label" for="modeStatus">ìƒíƒœ ë³€ê²½</label>
              <div class="mt-2 ms-4">
                <label for="delStatus" class="form-label visually-hidden">ìƒíƒœ</label>
                <select id="delStatus" name="status" class="form-select">
                  <option value="ACTIVE">ACTIVE</option>
                  <option value="WITHDRAWN">WITHDRAWN</option>
                </select>
              </div>
            </div>
            <div class="form-check mt-3">
              <input class="form-check-input" type="radio" name="mode" id="modeDrop" value="DROP">
              <label class="form-check-label text-danger" for="modeDrop">ë¬¼ë¦¬ì‚­ì œ(DROP) â€” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</label>
            </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="keyword"  th:value="${keyword}">
            <input type="hidden" name="category" th:value="${category}">
            <input type="hidden" name="sort"     th:value="${sort}">
            <input type="hidden" name="page"     th:value="${members.number}">
            <input type="hidden" name="size"     th:value="${members.size}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-danger">í™•ì¸</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 2100;">
    <div class="toast align-items-center text-bg-dark border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         th:classappend="${msg} != null ? ' show' : ''">
      <div class="d-flex">
        <div class="toast-body" th:text="${msg}">ì•Œë¦¼</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script>
    const editModalEl   = document.getElementById('editModal');
    const deleteModalEl = document.getElementById('deleteModal');

    // ìˆ˜ì • ëª¨ë‹¬
    if (editModalEl) {
      editModalEl.addEventListener('show.bs.modal', function (event) {
        const btn    = event.relatedTarget;
        const mno    = btn?.getAttribute('data-mno');
        const name   = btn?.getAttribute('data-name')  || '';
        const role   = btn?.getAttribute('data-role')  || 'USER';
        const grade  = btn?.getAttribute('data-grade') || 'BASIC';
        const points = btn?.getAttribute('data-points') || '0';

        const form = document.getElementById('editForm');
        const base = form.getAttribute('data-base') || '/admin/members';

        form.action = base + '/' + mno + '/update';
        form.memberName.value = name;
        form.querySelector('select[name="role"]').value  = role;
        form.querySelector('select[name="grade"]').value = grade;
        form.querySelector('input[name="points"]').value = points;
      });
    }

    // ì‚­ì œ ëª¨ë‹¬
    if (deleteModalEl) {
      deleteModalEl.addEventListener('show.bs.modal', function (event) {
        const btn    = event.relatedTarget;
        const mno    = btn?.getAttribute('data-mno');
        const name   = btn?.getAttribute('data-name') || '';
        const status = btn?.getAttribute('data-status') || 'ACTIVE';

        const form = document.getElementById('deleteForm');
        const base = form.getAttribute('data-base') || '/admin/members';

        form.action = base + '/' + mno + '/delete';
        form.querySelector('input[name="_memberName"]').value = name;

        form.querySelector('#modeStatus').checked = true;
        const sel = form.querySelector('select[name="status"]');
        sel.disabled = false;
        if (status && sel.querySelector('option[value="'+status+'"]')) {
          sel.value = status;
        }
      });

      deleteModalEl.addEventListener('change', function(e){
        if (e.target.name !== 'mode') return;
        const sel = deleteModalEl.querySelector('select[name="status"]');
        sel.disabled = !deleteModalEl.querySelector('#modeStatus').checked;
      });
    }

    // ì œì¶œ ê°€ë“œ
    function guardSubmit(form, pattern, makeConfirmMessage) {
      form.addEventListener('submit', function(e){
        const okAction = !!form.action && pattern.test(form.action);
        if (!okAction) { e.preventDefault(); alert('ëŒ€ìƒ íšŒì›ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
        const msg = makeConfirmMessage(form);
        if (msg && !confirm(msg)) e.preventDefault();
      });
    }

    const editForm = document.getElementById('editForm');
    if (editForm) {
      guardSubmit(
              editForm,
              /\/admin\/members\/\d+\/update$/,
              (f) => {
                const nm = f.memberName.value?.trim() || 'ì´ íšŒì›';
                const role  = f.querySelector('select[name="role"]').value;
                const grade = f.querySelector('select[name="grade"]').value;
                const pts   = f.querySelector('input[name="points"]').value || '0';
                return `ë³€ê²½ì‚¬í•­ì„ ì €ì¥í• ê¹Œìš”?\n\nëŒ€ìƒ: ${nm}\nì—­í• : ${role}\në“±ê¸‰: ${grade}\ní¬ì¸íŠ¸: ${pts}`;
              }
      );
    }

    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
      guardSubmit(
              deleteForm,
              /\/admin\/members\/\d+\/delete$/,
              (f) => {
                const isDrop = f.querySelector('#modeDrop').checked;
                const nm = f.querySelector('input[name="_memberName"]').value || 'ì´ íšŒì›';
                if (isDrop) return `ì •ë§ë¡œ ${nm}ì„(ë¥¼) ì™„ì „íˆ ì‚­ì œí• ê¹Œìš”?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                const st = f.querySelector('select[name="status"]').value;
                return `${nm}ì˜ ìƒíƒœë¥¼ ${st}(ìœ¼)ë¡œ ë³€ê²½í• ê¹Œìš”?`;
              }
      );
    }

    (function(){
      const toastEl = document.querySelector('.toast');
      if (toastEl && toastEl.classList.contains('show')) {
        const t = new bootstrap.Toast(toastEl, { delay: 2500 });
        t.show();
      }
    })();
  </script>
</th:block>
</body>
</html>