<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <title>주문 상세</title>
    <th:block layout:fragment="page_head">
        <!-- 로그인 사용자 정보 + CSRF -->
        <meta name="memberName" th:content="${#authentication?.principal?.memberName}">
        <meta name="memberId"   th:content="${#authentication?.principal?.memberId}">
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">

        <!-- CSS -->
        <link rel="stylesheet" th:href="@{/css/pages/order-detail.css}">
        <link rel="stylesheet" th:href="@{/css/shop/order-list.css}">
    </th:block>
</head>

<body>
<main layout:fragment="content" class="container order-detail-page">

    <!-- ✅ 주문 상세 헤더 -->
    <section class="text-center my-4">
        <h2>주문 상세 내역</h2>
        <p th:text="'주문번호: ' + ${order.orderNo}">주문번호: -</p>
    </section>

    <!-- ✅ 에러 메시지 -->
    <div th:if="${param.error}" class="alert alert-danger mt-3" role="alert">
        <span th:text="${param.error}">에러 메시지</span>
    </div>

    <!-- ✅ 주문 정보 -->
    <div class="card shadow-sm p-3 mb-4">
        <h4>주문 정보</h4>
        <ul>
            <li><strong>주문일자:</strong>
                <span th:text="${#temporals.format(order.orderedAt, 'yyyy-MM-dd HH:mm')}">-</span></li>
            <li><strong>결제금액:</strong>
                <span th:text="${#numbers.formatInteger(order.payableAmount,3,'COMMA')} + '원'">0원</span></li>
            <li><strong>결제수단:</strong> <span th:text="${order.payMethod}">-</span></li>
            <li><strong>주문상태:</strong>
                <span th:text="${order.status?.description}">-</span></li>
        </ul>
    </div>

    <!-- ✅ 주문자 정보 -->
    <div class="card shadow-sm p-3 mb-4">
        <h4>주문자 정보</h4>
        <ul>
            <li><strong>이름:</strong> <span th:text="${order.receiverName}">-</span></li>
            <li><strong>전화번호:</strong> <span th:text="${order.receiverPhone}">-</span></li>
        </ul>
    </div>

    <!-- ✅ 배송지 -->
    <div class="card shadow-sm p-3 mb-4">
        <h4>배송지</h4>
        <p th:text="${order.zipcode + ' ' + order.addr1 + ' ' + (order.addr2 != null ? order.addr2 : '')}">-</p>
    </div>

    <!-- ✅ 주문 상품 -->
    <div class="card shadow-sm p-3 mb-4">
        <h4>주문 상품</h4>
        <table class="table table-striped align-middle">
            <thead class="table-light">
            <tr>
                <th>상품명</th>
                <th class="text-center">수량</th>
                <th class="text-end">단가</th>
                <th class="text-end">합계</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="line : ${order.lines}">
                <td><a th:href="@{/item/{id}(id=${line.itemId})}" th:text="${line.itemName}">상품명</a></td>
                <td class="text-center" th:text="${line.quantity}">1</td>
                <td class="text-end" th:text="${#numbers.formatInteger(line.salePrice,3,'COMMA')} + '원'">0원</td>
                <td class="text-end fw-bold" th:text="${#numbers.formatInteger(line.lineTotal,3,'COMMA')} + '원'">0원</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ✅ 결제 요약 -->
    <div class="card shadow-sm p-3 mb-4">
        <h4>결제 요약</h4>
        <table class="table">
            <tbody>
            <tr>
                <th style="width:160px;">총 상품금액</th>
                <td th:text="${#numbers.formatInteger(order.productsTotal,3,'COMMA')} + '원'">0원</td>
            </tr>
            <tr th:if="${order.discountTotal > 0}">
                <th>등급 할인</th>
                <td class="text-danger"
                    th:text="'-' + ${#numbers.formatInteger(order.discountTotal,3,'COMMA')} + '원'">-0원</td>
            </tr>
            <tr>
                <th>배송비</th>
                <td th:text="${order.shippingFee == 0 ? '무료' : #numbers.formatInteger(order.shippingFee,3,'COMMA') + '원'}">0원</td>
            </tr>
            <tr class="fw-bold">
                <th>결제금액</th>
                <td th:text="${#numbers.formatInteger(order.payableAmount,3,'COMMA')} + '원'">0원</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ✅ 하단 버튼 -->
    <div class="mt-4 d-flex gap-2">
        <a th:href="@{/orders/list}" class="btn btn-secondary">주문 목록으로</a>

        <!-- 환불 요청 -->
        <button type="button"
                id="btnRefund"
                class="btn btn-warning"
                th:if="${order.status != null and (order.status.name() == 'DELIVERED' or order.status.name() == 'COMPLETED')}"
                th:data-order-id="${order.orderId}">
            환불 요청
        </button>

        <!-- 주문 취소 -->
        <form th:if="${order.status != null and (order.status.name() == 'CREATED' or order.status.name() == 'PREPARING')}"
              th:action="@{/orders/{id}/cancel(id=${order.orderId})}" method="post"
              class="d-inline"
              onsubmit="return confirm('정말 주문을 취소할까요?');">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="btn btn-danger">주문 취소</button>
        </form>

        <!-- 리뷰 버튼 -->
        <button type="button" class="btn btn-outline-primary js-open-review"
                th:if="${!#lists.isEmpty(order.lines)}"
                th:data-item-id="${order.lines[0]?.itemId}"
                th:data-item-name="${order.lines[0]?.itemName}"
                th:data-item-img="${order.lines[0]?.repImgUrl}"
                th:data-status="${order.status}">
            리뷰 작성
        </button>
    </div>

    <!-- ✅ 리뷰 작성 모달 -->
    <div id="review-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="rv-title">
            <div class="modal-hd">
                <h5 id="rv-title" class="mb-0">리뷰 작성</h5>
                <button type="button" class="btn-close" aria-label="닫기" data-close></button>
            </div>
            <div class="modal-bd">
                <form id="review-form">
                    <input type="hidden" name="itemId" id="rv-item-id">
                    <input type="hidden" name="writerMno" id="rv-writer-mno">
                    <input type="hidden" name="rating" id="rv-rating" value="5">

                    <!-- 상품 이미지 + 이름 -->
                    <div class="mb-3 text-center">
                        <img id="rv-item-img" src="/img/No_Image.jpg"
                             alt="상품 이미지" style="max-width:120px; border-radius:8px; margin-bottom:8px;">
                        <div id="rv-item-name" class="form-control-plaintext fw-semibold"></div>
                    </div>

                    <!-- 작성자 -->
                    <div class="mb-3">
                        <label class="form-label">작성자</label>
                        <div id="rv-writer-name" class="form-control-plaintext"></div>
                    </div>

                    <!-- 평점 -->
                    <div class="mb-3">
                        <label class="form-label d-block">평점</label>
                        <div id="rv-stars" class="rv-stars">
                            <div class="bg">★★★★★</div>
                            <div class="fill" style="width:20%">★★★★★</div>
                        </div>
                        <small id="rv-rating-label" class="text-muted">5점</small>
                    </div>

                    <!-- 내용 -->
                    <div class="mb-3">
                        <label for="rv-content" class="form-label">내용</label>
                        <textarea id="rv-content" name="content" class="form-control" rows="5"
                                  maxlength="2000" placeholder="리뷰 내용을 입력하세요 (최대 2000자)"></textarea>
                    </div>

                    <!-- 이미지 업로드 -->
                    <div class="mb-2">
                        <label class="form-label">이미지 (최대 3장, 3MB/장)</label>
                        <input id="rv-images" name="images" type="file" class="form-control"
                               accept=".jpg,.jpeg,.png,.gif" multiple>
                        <div id="rv-previews" class="rv-previews mt-2"></div>
                    </div>

                    <div id="rv-error" class="text-danger small mt-1" role="alert"></div>

                    <div class="modal-ft">
                        <button type="button" class="btn btn-outline-secondary" data-close>취소</button>
                        <button type="submit" id="rv-submit" class="btn btn-primary">등록</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ✅ 환불 요청 모달 -->
    <div id="refund-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="refund-title">
            <div class="modal-hd">
                <h5 id="refund-title" class="mb-0">환불 요청</h5>
                <button type="button" class="btn-close" aria-label="닫기" id="closeRefundModal"></button>
            </div>
            <div class="modal-bd">
                <form id="refund-form" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="orderId" id="refund-order-id">

                    <div class="mb-3">
                        <label for="refund-reason" class="form-label">환불 사유</label>
                        <select id="refund-reason" name="reason" class="form-select" required>
                            <option value="">선택하세요</option>
                            <option th:each="r : ${T(org.team.mealkitshop.common.RefundReason).values()}"
                                    th:value="${r}" th:text="${r.description}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="refund-detail" class="form-label">상세 사유</label>
                        <textarea id="refund-detail" name="reasonDetail" class="form-control" rows="3"
                                  placeholder="상세 사유를 입력하세요"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-ft">
                <button type="button" class="btn btn-outline-secondary" id="closeRefundModal2">취소</button>
                <button type="button" class="btn btn-primary" id="submitRefund">요청하기</button>
            </div>
        </div>
    </div>

    <!-- ✅ 모달 제어 스크립트 -->
    <script th:src="@{/js/shop/review-modal.js(v=${T(java.time.Instant).now().toEpochMilli()})}" defer></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const btnRefund = document.getElementById("btnRefund");
            const modal = document.getElementById("refund-modal");
            const closeBtns = [document.getElementById("closeRefundModal"), document.getElementById("closeRefundModal2")];
            const submitBtn = document.getElementById("submitRefund");
            const form = document.getElementById("refund-form");
            const orderIdInput = document.getElementById("refund-order-id");

            btnRefund?.addEventListener("click", () => {
                orderIdInput.value = btnRefund.dataset.orderId;
                modal.classList.add("show");
                modal.setAttribute("aria-hidden","false");
                document.body.style.overflow="hidden";
            });

            closeBtns.forEach(b => b?.addEventListener("click", () => {
                modal.classList.remove("show");
                modal.setAttribute("aria-hidden","true");
                document.body.style.overflow="";
            }));

            modal.addEventListener("click", e => {
                if (e.target === modal) {
                    modal.classList.remove("show");
                    modal.setAttribute("aria-hidden","true");
                    document.body.style.overflow="";
                }
            });

            submitBtn?.addEventListener("click", () => {
                form.action = `/orders/${orderIdInput.value}/refund`;
                form.submit();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && modal.classList.contains("show")) {
                    modal.classList.remove("show");
                    modal.setAttribute("aria-hidden","true");
                    document.body.style.overflow="";
                }
            });
        });
    </script>

    <!-- ✅ 모달 스타일 -->
    <style>
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1080}
        .modal-overlay.show{display:flex}
        .modal-card{background:#fff;border-radius:12px;padding:20px;width:min(480px,92vw);box-shadow:0 8px 20px rgba(0,0,0,.35)}
        .modal-hd{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:12px}
        .modal-ft{display:flex;gap:8px;justify-content:flex-end;border-top:1px solid #eee;padding-top:12px;margin-top:12px}
        .btn-close{border:0;background:transparent;font-size:20px;line-height:1}
    </style>
</main>
</body>
</html>
